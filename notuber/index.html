<!DOCTYPE html>

<html>

        <head>
                <title>Not Uber</title>
                <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
                <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
                <link rel="stylesheet" href="style.css" />
                
                <script type="text/javascript">
                        var my_lat = 0;
                        var my_lng = 0;
                        var xhr = new XMLHttpRequest();
                        var me = new google.maps.LatLng(my_lat, my_lng);
                        var myOptions = {
                                                zoom: 15, // The larger the zoom number, the bigger the zoom
                                                center: me,
                                                mapTypeId: google.maps.MapTypeId.ROADMAP
                                        }
                        var map;
                        var marker;
                        var infowindow = new google.maps.InfoWindow();
                        
                        function init()
                        {
                                console.log("1");
                                map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                                getMyLocation();
                        }
                        
                        function getMyLocation() {
                                if (navigator.geolocation) { 
                                        navigator.geolocation.getCurrentPosition(function(position) {
                                                my_lat = position.coords.latitude;
                                                my_lng = position.coords.longitude;
                                                wrapperGetData();
                                        });
                                }
                                else {
                                        alert("Geolocation unsupported on this browser");
                                }
                        }

                        function wrapperGetData() {
                                url = "https://defense-in-derpth.herokuapp.com/submit";
                                xhr.open("POST", url, true);
                                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                                var my_data;
                                xhr.onreadystatechange = function() { //Call a function when the state changes.
                                        if (this.readyState == 4 && this.status == 200) {
                                                my_data = JSON.parse(xhr.responseText);
                                                renderMap(my_data);
                                        }
                                }
                                xhr.send("username=6vZ9qT63&lat=" + my_lat + "&lng=" + my_lng);
                        }

                        function handleMarkerClick(marker, index)
                        {
                                return function() {
                                        stringContent = '<div id="username">' + marker.title + '<br/></div>' + '<div id="infoWindow">...is ' + 0 + ' miles away from me</div>';
                                        infowindow.setContent(stringContent);
                                        infowindow.open(map, marker);
                                };
                        }

                        function renderMap(my_data)
                        {
                                console.log(my_data);
                                console.log("2");
                                me = new google.maps.LatLng(my_lat, my_lng);
                                
                                // Update map and go there
                                map.panTo(me);
                                
                                // New person icon image
                                var person = {
                                        url: "person.png",
                                        size: new google.maps.Size(30, 30),
                                        scaledSize: new google.maps.Size(30, 30)
                                }

                                // New vehicle icon image
                                var vehicle = {
                                        url: "vehicle.png",
                                        size: new google.maps.Size(35, 15),
                                        scaledSize: new google.maps.Size(35, 15)
                                }

                                // Put others on the map
                                for (i = 0; i < my_data.vehicles.length; i++) {
                                        var pos = new google.maps.LatLng(my_data.vehicles[i].lat, my_data.vehicles[i].lng);
                                        
                                        // Create a marker
                                        marker = new google.maps.Marker ({
                                                position: pos,
                                                title: (my_data.vehicles[i].username),
                                                icon: vehicle
                                        });
                                        marker.setMap(map);
                                        google.maps.event.addListener(marker, 'click', handleMarkerClick(marker, i));
                                }
                        }
                        window.onload = init;
                </script>
        </head>
        
        <body>
                <div id="map_canvas"></div>
        </body>
</html>