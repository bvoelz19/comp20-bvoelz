<!DOCTYPE html>

<html>

        <head>
                <title>Not Uber</title>
                <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
                <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
                <link rel="stylesheet" href="style.css" />
                
                <script>
                        var my_lat = 0;
                        var my_lng = 0;
                        var xhr = new XMLHttpRequest();
                        var me = new google.maps.LatLng(my_lat, my_lng);
                        var myOptions = {
                                                zoom: 15, // The larger the zoom number, the bigger the zoom
                                                center: me,
                                                mapTypeId: google.maps.MapTypeId.ROADMAP
                                        }
                        var map;
                        var my_data;
                        var marker;
                        var infowindow = new google.maps.InfoWindow();
                        
                        function init()
                        {
                                map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                                getMyLocation();
                        }
                        
                        function getMyLocation() {
                                if (navigator.geolocation) { 
                                        navigator.geolocation.getCurrentPosition(function(position) {
                                                my_lat = position.coords.latitude;
                                                my_lng = position.coords.longitude;
                                                wrapperGetData();
                                                console.log("1");
                                                renderMap();
                                        });
                                }
                                else {
                                        alert("Geolocation unsupported on this browser");
                                }
                        }

                        function wrapperGetData() {
                                url = "https://defense-in-derpth.herokuapp.com/submit";
                                xhr.open("POST", url, true);
                                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                                
                                xhr.onreadystatechange = function() { //Call a function when the state changes.
                                        if (this.readyState == 4 && this.status == 200) {
                                                console.log(xhr.responseText);
                                                my_data = JSON.parse(xhr.responseText);
                                        }
                                }

                                xhr.send("username=6vZ9qT63&lat=" + my_lat + "&lng=" + my_lng);
                        }

                        function renderMap()
                        {
                                console.log("2");
                                me = new google.maps.LatLng(my_lat, my_lng);
                                
                                console.log("vehicles length: " + my_data.["vehicles"].length);

                                // Update map and go there
                                map.panTo(me);
                                
                                // New icon image
                                var image = {
                                        url: "person.png",
                                        size: new google.maps.Size(30, 30),
                                        scaledSize: new google.maps.Size(30, 30)
                                }

                                // Put me on the map
                                marker = new google.maps.Marker ({
                                        position: me,
                                        title: "Temp",
                                        icon: image
                                });
                                marker.setMap(map);
                                google.maps.event.addListener(marker, 'click', function() {
                                        infowindow.setContent(marker.title);
                                        infowindow.open(map, marker);
                                });


                                if (my_data == undefined) {
                                        return;
                                }
                                // Put others on the map
                                for (i = 0; i < 1; i++) {
                                        //var pos = new google.maps.LatLng(my_data.vehicles[i].lat, my_data.vehicles[i].lng);
                                        
                                        // Create a marker
                                        marker = new google.maps.Marker ({
                                                //position: pos,
                                                title: "Temp",
                                                icon: image
                                        });
                                        marker.setMap(map);
                                                
                                        // Open info window on when you click on the marker
                                        google.maps.event.addListener(marker, 'click', function() {
                                                infowindow.setContent(marker.title);
                                                infowindow.open(map, marker);
                                        });
                                }
                        }

                </script>
        </head>
        
        <body onload="init()">
                <div id="map_canvas"></div>
        </body>
</html>